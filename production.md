# Production Deployment (Internet Computer Mainnet)

This project targets the Internet Computer (IC) mainnet using DFX and Motoko canisters with a React + Vite frontend.

## Prerequisites
- Node `>=16`, npm `>=7`.
- DFX installed (project developed with `DFX_VERSION=0.28.0`).
  - Install: `sh -ci "$(curl -fsSL https://internetcomputer.org/install.sh)"`
  - Verify: `dfx --version`
- An IC identity for production: `dfx identity new prod && dfx identity use prod`.
- Cycles to deploy canisters on mainnet.

## One‑time Mainnet Setup
- Identity: `dfx identity use prod` and back up its key securely (consider a hardware key via `dfx identity use <fido>`).
- Get cycles:
  - Acquire ICP on an exchange/NNS, then convert to cycles via the NNS dapp or the cycles ledger.
  - Check cycles: `dfx cycles balance --network ic`.

## Network And Environment
- Root `.env` is auto‑generated by DFX (`output_env_file` in `dfx.json`).
- For mainnet, ensure after deploy it contains: `DFX_NETWORK=ic` and `CANISTER_ID_*` values.
- The frontend build reads env from root `.env` via Vite config and injects `DFX_*/CANISTER_*` variables.

## Mainnet Canister IDs Required
The backend requires real mainnet principals for external canisters. Use these IDs on IC mainnet:
- `btcMinter` (ckBTC minter): `principal "mqygn-kiaaa-aaaar-qaadq-cai"`
- `ethMinter` (ckETH minter): `principal "sv3dd-oaaaa-aaaar-qacoa-cai"`
- `ckBTCLedger` (ckBTC ICRC‑1 ledger): `principal "mxzaz-hqaaa-aaaar-qaada-cai"`
- `ckUSDCLedger` (ckUSDC ICRC‑1 ledger): `principal "xevnm-gaaaa-aaaar-qafnq-cai"`
- `ckBTCckUSDCPair` (DEX pair for ckBTC/ckUSDC): `principal "mhecj-xyaaa-aaaag-qjyjq-cai"` (ICPSwap or your chosen DEX)

Where to set them:
- Option A (simplest): Edit `dfx.json` `canisters.app_backend.init` to the correct `principal "..."` values for the `ic` network before deploying.
- Option B (CLI override): Deploy `app_backend` with an explicit `--argument` for mainnet:

```
dfx deploy app_backend --network ic \
  --argument '(opt record {
    btcMinter = principal "mqygn-kiaaa-aaaar-qaadq-cai";
    ethMinter = principal "sv3dd-oaaaa-aaaar-qacoa-cai";
    ckBTCckUSDCPair = principal "mhecj-xyaaa-aaaag-qjyjq-cai";
    ckUSDCLedger = principal "xevnm-gaaaa-aaaar-qafnq-cai";
    ckBTCLedger = principal "mxzaz-hqaaa-aaaar-qaada-cai"
  })'
```

Note: Do not use the local placeholder principals (e.g., `...-77774-...`) on mainnet.

## Build Frontend For Mainnet
- Generate declarations and build assets targeting `ic`:

```
# from repo root
dfx generate
npm --workspace src/app_frontend run build:ic
```

This produces `src/app_frontend/dist` used by the `assets` canister.

### Frontend Env Notes
- Vite loads env from the root `.env` via `vite.config.js` (`dotenv.config({ path: '../../.env' })`).
- The `build:ic` script sets `DFX_NETWORK=ic` and will not be overridden by `.env`.
- After deploying to `ic`, `dfx` writes `CANISTER_ID_*` values to the root `.env`; the frontend build injects those.
- The file `src/app_frontend/.env` is intended for local dev. It is not used for production builds by this setup. To avoid confusion, keep it set to `DFX_NETWORK=local` or remove it before running a production build.

## Deploy To Mainnet
1) Use the production identity and confirm cycles:
```
dfx identity use prod
dfx cycles balance --network ic
```

2) Deploy dependencies (if any are local/custom):
- `internet_identity` is configured with the remote mainnet ID in `dfx.json` and won’t be redeployed.
- If you manage any custom canisters yourself (e.g., mock canisters are for local only), skip them on `ic`.

3) Deploy backend with correct init principals:
```
# Option A: if `dfx.json` already contains correct mainnet principals
dfx deploy app_backend --network ic

# Option B: override init on CLI (see example in prior section)
```

4) Deploy the asset canister (serves the built frontend):
```
dfx deploy app_frontend --network ic
```

5) Verify env output:
```
cat .env | grep -E "DFX_NETWORK|CANISTER_ID_"
```

## URLs And Verification
- App URL: `https://<CANISTER_ID_APP_FRONTEND>.icp0.io/` (or `https://<id>.ic0.app/`).
- Check status:
```
dfx canister --network ic status app_backend
```
- Call a simple query (example):
```
dfx canister --network ic call app_backend <methodName>
```

## Upgrades & Changes
- Backend code changes:
```
dfx deploy app_backend --network ic --upgrade-unchanged
```
- Frontend changes:
```
npm --workspace src/app_frontend run build:ic
dfx deploy app_frontend --network ic
```

## Safety Checklist
- Double‑check all external canister principals (ckBTC/ckUSDC/DEX/minters) are the mainnet IDs.
- Ensure `DFX_NETWORK=ic` during production builds and deploys.
- Use a dedicated production identity and secure the keys.
- Keep a buffer of cycles to avoid failed deploy/upgrade operations.

## Troubleshooting
- Mismatched canister IDs in frontend: rebuild with `build:ic` after mainnet deploy so env is correct.
- Local placeholders on mainnet: redeploy `app_backend` with correct `--argument` principals or update `dfx.json`.
- Stuck state or schema change: you may need to `dfx canister --network ic stop app_backend` then `dfx deploy ...` (be cautious; stopping halts service temporarily).
### One-liner scripts
For convenience, you can use the npm scripts added to `package.json`:

```
# Backend deploy with mainnet init args
npm run deploy:ic:backend

# Build frontend for ic and deploy assets canister
npm run deploy:ic:frontend

# Do both in sequence
npm run deploy:ic
```
